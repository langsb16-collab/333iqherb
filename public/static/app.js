// Translations
const translations = {
  ko: {
    subtitle: 'í”„ë¡œì íŠ¸ê°€ ìë³¸ì„ ë§Œë‚˜ëŠ” ê³³',
    hero_title: 'Code your vision,<br>build your future',
    hero_desc: 'ê°œë°œì, ì „ëµì  íˆ¬ìì ì¡°ë‹¬ í—ˆë¸Œ',
    type_investment: 'íˆ¬ì',
    type_revenue: 'ìˆ˜ìµë¶„ë°°',
    type_startup: 'ì°½ì—…í¬ë§',
    loading: 'í”„ë¡œì íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...',
    no_projects: 'ë“±ë¡ëœ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤',
    footer_title: 'í”„ë¡œì íŠ¸ê°€ ìë³¸ì„ ë§Œë‚˜ëŠ” ê³³',
    video_label: 'ì˜ìƒ ë³´ê¸°',
    detail_title: 'í”„ë¡œì íŠ¸ ìƒì„¸ ì •ë³´',
    admin_title: 'ê´€ë¦¬ì í˜ì´ì§€',
    admin_home: 'ë©”ì¸',
    new_project: 'ìƒˆ í”„ë¡œì íŠ¸',
    registered_projects: 'ë“±ë¡ëœ í”„ë¡œì íŠ¸',
    project_name: 'í”„ë¡œì íŠ¸ëª…',
    description: 'í•œì¤„ ì†Œê°œ',
    category: 'ì¹´í…Œê³ ë¦¬',
    funding_type: 'ìê¸ˆ ë°©ì‹',
    amount: 'í¬ë§ ê¸ˆì•¡ (USD $)',
    youtube_links: 'ìœ íŠœë¸Œ ë§í¬ (ìµœëŒ€ 5ê°œ)',
    youtube_link: 'ìœ íŠœë¸Œ ë§í¬',
    text_info: 'í…ìŠ¤íŠ¸ ì •ë³´',
    cancel: 'ì·¨ì†Œ',
    save: 'ì €ì¥',
    edit: 'ìˆ˜ì •',
    delete: 'ì‚­ì œ',
    confirm_delete: 'ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
    success_added: 'âœ… ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤',
    success_updated: 'âœ… ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤',
    success_deleted: 'ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤',
    error_save: 'âŒ ì €ì¥ ì˜¤ë¥˜: ',
    error_delete: 'ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤',
    select: 'ì„ íƒ',
    category_app: 'ì•±',
    category_web: 'ì›¹í”Œë«í¼',
    category_o2o: 'O2O',
    category_game: 'ê²Œì„',
    category_etc: 'ê¸°íƒ€',
    click_to_play: 'í´ë¦­í•˜ì—¬ ì¬ìƒ'
  },
  en: {
    subtitle: 'Where Projects Meet Capital',
    hero_title: 'Code your vision,<br>build your future',
    hero_desc: 'Developer & Strategic Investor Hub',
    type_investment: 'Investment',
    type_revenue: 'Revenue Share',
    type_startup: 'Startup',
    loading: 'Loading projects...',
    no_projects: 'No projects registered',
    footer_title: 'Where Projects Meet Capital',
    video_label: 'Watch Video',
    detail_title: 'Project Details',
    admin_title: 'Admin Panel',
    admin_home: 'Home',
    new_project: 'New Project',
    registered_projects: 'Registered Projects',
    project_name: 'Project Name',
    description: 'Description',
    category: 'Category',
    funding_type: 'Funding Type',
    amount: 'Target Amount (USD $)',
    youtube_links: 'YouTube Links (Max 5)',
    youtube_link: 'YouTube Link',
    text_info: 'Detailed Info',
    cancel: 'Cancel',
    save: 'Save',
    edit: 'Edit',
    delete: 'Delete',
    confirm_delete: 'Are you sure you want to delete?',
    success_added: 'âœ… Added successfully',
    success_updated: 'âœ… Updated successfully',
    success_deleted: 'Deleted successfully',
    error_save: 'âŒ Save error: ',
    error_delete: 'Error occurred while deleting',
    select: 'Select',
    category_app: 'App',
    category_web: 'Web Platform',
    category_o2o: 'O2O',
    category_game: 'Game',
    category_etc: 'Other',
    click_to_play: 'Click to Play'
  },
  zh: {
    subtitle: 'é¡¹ç›®ä¸èµ„æœ¬ç›¸é‡ä¹‹åœ°',
    hero_title: 'Code your vision,<br>build your future',
    hero_desc: 'å¼€å‘è€…ä¸æˆ˜ç•¥æŠ•èµ„è€…æ¢çº½',
    type_investment: 'æŠ•èµ„',
    type_revenue: 'æ”¶ç›Šåˆ†é…',
    type_startup: 'åˆ›ä¸šå¸Œæœ›',
    loading: 'æ­£åœ¨åŠ è½½é¡¹ç›®...',
    no_projects: 'æ²¡æœ‰æ³¨å†Œçš„é¡¹ç›®',
    footer_title: 'é¡¹ç›®ä¸èµ„æœ¬ç›¸é‡ä¹‹åœ°',
    video_label: 'è§‚çœ‹è§†é¢‘',
    detail_title: 'é¡¹ç›®è¯¦æƒ…',
    admin_title: 'ç®¡ç†å‘˜é¡µé¢',
    admin_home: 'ä¸»é¡µ',
    new_project: 'æ–°é¡¹ç›®',
    registered_projects: 'å·²æ³¨å†Œé¡¹ç›®',
    project_name: 'é¡¹ç›®åç§°',
    description: 'ç®€ä»‹',
    category: 'ç±»åˆ«',
    funding_type: 'èµ„é‡‘æ–¹å¼',
    amount: 'ç›®æ ‡é‡‘é¢ï¼ˆç¾å…ƒ $ï¼‰',
    youtube_links: 'YouTubeé“¾æ¥ï¼ˆæœ€å¤š5ä¸ªï¼‰',
    youtube_link: 'YouTubeé“¾æ¥',
    text_info: 'è¯¦ç»†ä¿¡æ¯',
    cancel: 'å–æ¶ˆ',
    save: 'ä¿å­˜',
    edit: 'ç¼–è¾‘',
    delete: 'åˆ é™¤',
    confirm_delete: 'ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ',
    success_added: 'âœ… æ·»åŠ æˆåŠŸ',
    success_updated: 'âœ… ä¿®æ”¹æˆåŠŸ',
    success_deleted: 'åˆ é™¤æˆåŠŸ',
    error_save: 'âŒ ä¿å­˜é”™è¯¯ï¼š',
    error_delete: 'åˆ é™¤æ—¶å‘ç”Ÿé”™è¯¯',
    select: 'é€‰æ‹©',
    category_app: 'åº”ç”¨',
    category_web: 'ç½‘ç»œå¹³å°',
    category_o2o: 'O2O',
    category_game: 'æ¸¸æˆ',
    category_etc: 'å…¶ä»–',
    click_to_play: 'ç‚¹å‡»æ’­æ”¾'
  }
};

let currentLang = localStorage.getItem('lang') || 'ko';
let projects = [];
let editing = null;

function changeLang(lang) {
  currentLang = lang;
  localStorage.setItem('lang', lang);
  
  // Update language buttons
  document.querySelectorAll('.lang-btn').forEach(btn => {
    btn.classList.remove('active');
    if (btn.dataset.lang === lang) {
      btn.classList.add('active');
    }
  });
  
  // Update all translated elements
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.dataset.i18n;
    if (translations[lang][key]) {
      el.innerHTML = translations[lang][key];
    }
  });
  
  // Reload projects with new language
  loadProjects();
}

function t(key) {
  return translations[currentLang][key] || translations['ko'][key] || key;
}

function translateFundingType(type) {
  const fundingMap = {
    'investment': {
      'ko': 'íˆ¬ì',
      'en': 'Investment',
      'zh': 'æŠ•èµ„'
    },
    'donation': {
      'ko': 'ìˆ˜ìµë¶„ë°°',
      'en': 'Revenue Share',
      'zh': 'æ”¶ç›Šåˆ†é…'
    },
    'startup': {
      'ko': 'ì°½ì—…í¬ë§',
      'en': 'Startup',
      'zh': 'åˆ›ä¸šå¸Œæœ›'
    }
  };
  
  // If type is one of the key values (investment, donation, startup)
  if (fundingMap[type]) {
    return fundingMap[type][currentLang];
  }
  
  // If type is already translated, find the key and translate again
  for (const key of Object.keys(fundingMap)) {
    const values = Object.values(fundingMap[key]);
    if (values.includes(type)) {
      return fundingMap[key][currentLang];
    }
  }
  
  return type;
}

function translateCategory(category) {
  const categoryMap = {
    'ko': { 'ì•±': 'ì•±', 'ì›¹í”Œë«í¼': 'ì›¹í”Œë«í¼', 'O2O': 'O2O', 'ê²Œì„': 'ê²Œì„', 'ê¸°íƒ€': 'ê¸°íƒ€' },
    'en': { 'ì•±': 'App', 'ì›¹í”Œë«í¼': 'Web Platform', 'O2O': 'O2O', 'ê²Œì„': 'Game', 'ê¸°íƒ€': 'Other' },
    'zh': { 'ì•±': 'åº”ç”¨', 'ì›¹í”Œë«í¼': 'ç½‘ç»œå¹³å°', 'O2O': 'O2O', 'ê²Œì„': 'æ¸¸æˆ', 'ê¸°íƒ€': 'å…¶ä»–' }
  };
  
  for (const ko of Object.keys(categoryMap['ko'])) {
    if (category === ko || category === categoryMap['en'][ko] || category === categoryMap['zh'][ko]) {
      return categoryMap[currentLang][ko];
    }
  }
  
  return category;
}

function getTranslatedField(project, field) {
  const langField = `${field}_${currentLang}`;
  if (project[langField]) {
    return project[langField];
  }
  
  const baseValue = project[field] || '';
  if (baseValue.includes('|||')) {
    const parts = baseValue.split('|||').map(s => s.trim());
    if (currentLang === 'ko') return parts[0] || baseValue;
    if (currentLang === 'en') return parts[1] || parts[0] || baseValue;
    if (currentLang === 'zh') return parts[2] || parts[0] || baseValue;
  }
  
  return baseValue;
}

// Initialize language on load
document.addEventListener('DOMContentLoaded', () => {
  changeLang(currentLang);
});

// Load projects from API
async function loadProjects() {
  const container = document.getElementById('projectsContainer');
  const loading = document.getElementById('loadingIndicator');
  const empty = document.getElementById('emptyState');

  try {
    const response = await axios.get('/api/projects');
    projects = response.data.data || [];
    
    loading.style.display = 'none';
    
    if (projects.length === 0) {
      empty.classList.remove('hidden');
      return;
    }

    container.innerHTML = projects.map(project => {
      // Count YouTube videos
      const youtubeUrls = [
        project.youtube_url_1,
        project.youtube_url_2,
        project.youtube_url_3,
        project.youtube_url_4,
        project.youtube_url_5
      ].filter(url => url && url.trim());
      
      const videoCount = youtubeUrls.length;
      const title = getTranslatedField(project, 'title');
      const description = getTranslatedField(project, 'description');
      const categoryRaw = project.category || 'ê¸°íƒ€';
      const category = translateCategory(categoryRaw);
      const fundingType = translateFundingType(project.funding_type);
      
      // Determine badge class based on funding type
      let badgeClass = 'badge-investment';
      if (project.funding_type === 'investment') {
        badgeClass = 'badge-investment';
      } else if (project.funding_type === 'donation') {
        badgeClass = 'badge-revenue';
      } else if (project.funding_type === 'startup') {
        badgeClass = 'badge-startup';
      }
      
      return `
      <div class="bg-white rounded-lg shadow card-hover overflow-hidden cursor-pointer" onclick="showProjectDetail('${project.id}')">
        <div class="p-3">
          <div class="mb-2 text-center">
            <span class="category-label category-${categoryRaw}">${category}</span>
          </div>
          <h3 class="text-sm font-bold text-gray-900 mb-2 line-clamp-1 text-center">${title}</h3>
          <p class="text-xs text-gray-600 mb-2 line-clamp-2 text-center">${description || ''}</p>
          <div class="flex flex-wrap gap-1.5 justify-center">
            <span class="badge ${badgeClass}" style="font-size: 0.75rem; padding: 0.4rem 0.8rem;">
              ${fundingType}
            </span>
            <span class="amount-badge" style="font-size: 0.75rem; padding: 0.4rem 0.8rem;">
              $${(project.amount || 0).toLocaleString()}
            </span>
            ${videoCount > 0 ? `<span class="badge" style="background:#3B82F6; color:white; font-size: 0.75rem; padding: 0.4rem 0.8rem;"><i class="fab fa-youtube mr-1"></i>${videoCount}ê°œ ${t('video_label')}</span>` : ''}
          </div>
        </div>
      </div>
    `;
    }).join('');
  } catch (error) {
    console.error('Error loading projects:', error);
    loading.style.display = 'none';
    empty.classList.remove('hidden');
  }
}

function getYouTubeVideoId(url) {
  if (!url) return null;
  const patterns = [
    /(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\s?]+)/,
    /youtube\.com\/embed\/([^&\s?]+)/,
    /youtube\.com\/v\/([^&\s?]+)/,
    /youtube\.com\/shorts\/([^&\s?]+)/
  ];
  for (const pattern of patterns) {
    const match = url.match(pattern);
    if (match && match[1]) return match[1].substring(0, 11);
  }
  return null;
}

function showProjectDetail(id) {
  const project = projects.find(p => p.id == id);
  if (!project) return;
  
  // Get all YouTube URLs
  const youtubeUrls = [
    project.youtube_url_1,
    project.youtube_url_2,
    project.youtube_url_3,
    project.youtube_url_4,
    project.youtube_url_5
  ].filter(url => url && url.trim()).map(url => getYouTubeVideoId(url)).filter(id => id);
  
  const title = getTranslatedField(project, 'title');
  const description = getTranslatedField(project, 'description');
  const textInfo = getTranslatedField(project, 'text_info');
  const fundingType = translateFundingType(project.funding_type);
  
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
  modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
  
  // Get all Image URLs
  const imageUrls = [
    project.image_url_1,
    project.image_url_2,
    project.image_url_3,
    project.image_url_4,
    project.image_url_5
  ].filter(url => url && url.trim());
  
  // Images section HTML
  let imagesHTML = '';
  if (imageUrls.length > 0) {
    console.log('ğŸ–¼ï¸ ì´ë¯¸ì§€ ê°œìˆ˜:', imageUrls.length);
    console.log('ğŸ–¼ï¸ ì²« ì´ë¯¸ì§€ ê¸¸ì´:', imageUrls[0] ? imageUrls[0].length : 0);
    imagesHTML = `
      <div class="bg-blue-50 rounded-lg p-4">
        <h3 class="text-lg font-bold mb-3 text-center">
          <i class="fas fa-images text-blue-600 mr-2"></i>í”„ë¡œì íŠ¸ ì´ë¯¸ì§€ (${imageUrls.length}ê°œ)
        </h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          ${imageUrls.map((url, index) => `
            <div class="relative group cursor-pointer" data-image-index="${index}">
              <img src="${url}" alt="ì´ë¯¸ì§€ ${index + 1}" class="w-full h-auto rounded-lg shadow-md hover:shadow-xl transition-shadow" onerror="console.error('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:', this.alt)">
              <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-10 transition-opacity rounded-lg flex items-center justify-center">
                <i class="fas fa-search-plus text-white text-3xl opacity-0 group-hover:opacity-100 transition-opacity"></i>
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  } else {
    console.log('âš ï¸ ì´ë¯¸ì§€ ì—†ìŒ');
  }
  
  // Videos section HTML - vertical layout for 2-5 videos
  let videosHTML = '';
  if (youtubeUrls.length > 0) {
    videosHTML = `
      <div class="bg-gray-50 rounded-lg p-4">
        <h3 class="text-lg font-bold mb-3 text-center">
          <i class="fab fa-youtube text-red-600 mr-2"></i>${t('video_label')} (${youtubeUrls.length}ê°œ)
        </h3>
        <div class="space-y-4 max-w-3xl mx-auto">
          ${youtubeUrls.map((videoId, index) => `
            <div class="youtube-thumbnail" id="video-${index}" onclick="playVideo('video-${index}', '${videoId}')">
              <img src="https://img.youtube.com/vi/${videoId}/hqdefault.jpg" alt="Video ${index + 1}">
              <div class="play-button"></div>
              <div class="absolute bottom-2 right-2 bg-black bg-opacity-75 text-white text-xs px-2 py-1 rounded">
                ${t('click_to_play')}
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }
  
  modal.innerHTML = `
    <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b flex justify-between items-center sticky top-0 bg-white z-10">
        <div class="flex-1">
          <h2 class="text-2xl font-bold text-gray-900">${title}</h2>
          <p class="text-sm text-gray-500 mt-1">${description || ''}</p>
        </div>
        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 ml-4">
          <i class="fas fa-times text-2xl"></i>
        </button>
      </div>
      <div class="p-6 space-y-6">
        <div class="flex flex-wrap gap-2 justify-center">
          <span class="badge badge-${(project.funding_type || '').includes('íˆ¬ì') || (project.funding_type || '').includes('Investment') || (project.funding_type || '').includes('æŠ•èµ„') ? 'investment' : (project.funding_type || '').includes('ìˆ˜ìµ') || (project.funding_type || '').includes('Revenue') || (project.funding_type || '').includes('æ”¶ç›Š') ? 'revenue' : 'loan'}">
            <i class="fas fa-tag mr-1"></i>${fundingType}
          </span>
          <span class="amount-tag">
            <i class="fas fa-dollar-sign mr-1"></i>$${(project.amount || 0).toLocaleString()}
          </span>
        </div>
        
        ${imagesHTML}
        
        ${videosHTML}
        
        ${textInfo ? `
          <div class="bg-white border-2 border-purple-200 rounded-lg p-6">
            <h3 class="text-xl font-bold mb-4 text-purple-700 text-center">
              <i class="fas fa-file-alt mr-2"></i>${t('detail_title')}
            </h3>
            <div class="text-gray-700 whitespace-pre-wrap leading-relaxed text-center">
              ${textInfo.split('\n').map(line => 
                line.trim() ? `<p class="mb-3">${line}</p>` : '<br>'
              ).join('')}
            </div>
          </div>
        ` : ''}
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
}

function playVideo(containerId, videoId) {
  const container = document.getElementById(containerId);
  container.innerHTML = `
    <div class="relative pb-[56.25%] h-0">
      <iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1" 
        class="absolute top-0 left-0 w-full h-full rounded-lg"
        frameborder="0" allowfullscreen allow="autoplay"></iframe>
    </div>
  `;
}

// ADMIN FUNCTIONS
async function loadProjectsForAdmin() {
  try {
    const response = await axios.get('/api/projects');
    projects = response.data.data || [];
  } catch (error) {
    console.error('Failed to load projects:', error);
    projects = [];
  }
}

async function renderAdminPanel() {
  await loadProjectsForAdmin();
  
  document.getElementById('adminContent').innerHTML = `
    <header class="bg-white shadow p-4">
      <div class="max-w-7xl mx-auto">
        <div class="flex justify-between items-center mb-3">
          <h1 class="text-2xl font-bold"><i class="fas fa-cog text-purple-600 mr-2"></i>${t('admin_title')}</h1>
          <a href="/" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">
            <i class="fas fa-home mr-2"></i>${t('admin_home')}
          </a>
        </div>
      </div>
    </header>
    
    <div class="max-w-7xl mx-auto px-4 py-4">
      <div class="flex gap-2 mb-3">
        <button onclick="showForm()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
          <i class="fas fa-plus mr-2"></i>${t('new_project')}
        </button>
      </div>
      <div class="bg-white rounded-xl shadow">
        <div class="p-6 border-b"><h3 class="text-xl font-bold">${t('registered_projects')} (${projects.length}ê°œ)</h3></div>
        <div>${projects.length ? projects.map(p => `
          <div class="p-6 border-b hover:bg-gray-50">
            <div class="flex justify-between">
              <div class="flex-1">
                <h4 class="text-lg font-bold mb-2">${p.title}</h4>
                <p class="text-gray-600 text-sm mb-3">${p.description || ''}</p>
                <div class="flex gap-2 text-sm flex-wrap">
                  <span class="px-3 py-1 bg-purple-100 text-purple-800 rounded-full">${p.funding_type}</span>
                  <span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full font-bold">$${(p.amount||0).toLocaleString()}</span>
                  ${[p.youtube_url_1, p.youtube_url_2, p.youtube_url_3, p.youtube_url_4, p.youtube_url_5].filter(u => u).length > 0 ? 
                    `<span class="px-3 py-1 bg-red-100 text-red-800 rounded-full"><i class="fab fa-youtube mr-1"></i>${[p.youtube_url_1, p.youtube_url_2, p.youtube_url_3, p.youtube_url_4, p.youtube_url_5].filter(u => u).length}ê°œ</span>` 
                    : ''}
                </div>
              </div>
              <div class="flex gap-2 ml-4">
                <button onclick="edit('${p.id}')" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"><i class="fas fa-edit"></i></button>
                <button onclick="del('${p.id}')" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700"><i class="fas fa-trash"></i></button>
              </div>
            </div>
          </div>
        `).join('') : '<div class="p-12 text-center text-gray-500"><i class="fas fa-inbox text-6xl mb-4"></i><p>' + t('no_projects') + '</p></div>'}</div>
      </div>
    </div>

    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50" onclick="if(event.target===this) closeForm()">
      <div class="min-h-screen px-4 py-8 flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
          <div class="p-6 border-b flex justify-between items-center">
            <h2 class="text-2xl font-bold" id="formTitle">${t('new_project')}</h2>
            <button onclick="closeForm()" class="text-gray-500 hover:text-gray-700">
              <i class="fas fa-times text-2xl"></i>
            </button>
          </div>
          <form id="form" class="p-6 space-y-4" onsubmit="save(event)">
            <div class="bg-blue-50 p-4 rounded-lg mb-4">
              <p class="text-sm text-blue-800 font-medium mb-2"><i class="fas fa-info-circle mr-1"></i> ë‹¤êµ­ì–´ ì…ë ¥ ì•ˆë‚´</p>
              <p class="text-xs text-blue-600">í•œêµ­ì–´, ì˜ì–´, ì¤‘êµ­ì–´ ìˆœì„œë¡œ ì…ë ¥í•˜ì„¸ìš”. êµ¬ë¶„ì: <strong>|||</strong></p>
              <p class="text-xs text-blue-600 mt-1">ì˜ˆ: í•œêµ­ì–´ì œëª©|||English Title|||ä¸­æ–‡æ ‡é¢˜</p>
            </div>
            
            <div><label class="block text-sm font-medium mb-2">${t('project_name')} * (í•œêµ­ì–´|||English|||ä¸­æ–‡)</label>
            <input name="title" required class="w-full border rounded px-4 py-2" placeholder="ì˜ˆ: ì•± ê°œë°œ í”„ë¡œì íŠ¸|||App Development Project|||åº”ç”¨å¼€å‘é¡¹ç›®"></div>
            <div><label class="block text-sm font-medium mb-2">${t('description')} (í•œêµ­ì–´|||English|||ä¸­æ–‡)</label>
            <textarea name="description" rows="2" class="w-full border rounded px-4 py-2" placeholder="ì˜ˆ: í˜ì‹ ì ì¸ ëª¨ë°”ì¼ ì•±|||Innovative mobile app|||åˆ›æ–°ç§»åŠ¨åº”ç”¨"></textarea></div>
            
            <div class="grid grid-cols-2 gap-4">
              <div><label class="block text-sm font-medium mb-2">${t('category')} *</label>
              <select name="category" required class="w-full border rounded px-4 py-2">
                <option value="">ì„ íƒ</option>
                <option value="ì•±">ì•±</option>
                <option value="ì›¹í”Œë«í¼">ì›¹í”Œë«í¼</option>
                <option value="O2O">O2O</option>
                <option value="ê²Œì„">ê²Œì„</option>
                <option value="ê¸°íƒ€">ê¸°íƒ€</option>
              </select></div>
              <div><label class="block text-sm font-medium mb-2">${t('funding_type')} *</label>
              <select name="funding_type" required class="w-full border rounded px-4 py-2">
                <option value="">ì„ íƒ</option>
                <option value="investment">íˆ¬ì</option>
                <option value="donation">ìˆ˜ìµë¶„ë°°</option>
                <option value="startup">ì°½ì—…í¬ë§</option>
              </select></div>
              <div class="col-span-2"><label class="block text-sm font-medium mb-2">${t('amount')} *</label>
              <input type="number" name="amount" required min="0" step="100" class="w-full border rounded px-4 py-2"></div>
            </div>
            
            <div class="border-t pt-4 mt-4">
              <label class="block text-sm font-medium mb-3">
                <i class="fab fa-youtube text-red-600 mr-1"></i>${t('youtube_links')}
              </label>
              <div class="space-y-2">
                <input type="url" name="youtube_url_1" placeholder="YouTube ë§í¬ #1" class="w-full border rounded px-4 py-2 text-sm">
                <input type="url" name="youtube_url_2" placeholder="YouTube ë§í¬ #2" class="w-full border rounded px-4 py-2 text-sm">
                <input type="url" name="youtube_url_3" placeholder="YouTube ë§í¬ #3" class="w-full border rounded px-4 py-2 text-sm">
                <input type="url" name="youtube_url_4" placeholder="YouTube ë§í¬ #4" class="w-full border rounded px-4 py-2 text-sm">
                <input type="url" name="youtube_url_5" placeholder="YouTube ë§í¬ #5" class="w-full border rounded px-4 py-2 text-sm">
              </div>
            </div>
            
            <div class="border-t pt-4 mt-4">
              <label class="block text-sm font-medium mb-3">
                <i class="fas fa-images text-blue-600 mr-1"></i>ì´ë¯¸ì§€ ì—…ë¡œë“œ (ìµœëŒ€ 5ê°œ)
              </label>
              <div class="bg-blue-50 p-3 rounded-lg mb-3">
                <p class="text-xs text-blue-800 font-medium mb-1"><i class="fas fa-info-circle mr-1"></i> PCì—ì„œ ì´ë¯¸ì§€ ì—…ë¡œë“œ</p>
                <p class="text-xs text-blue-700">JPG, PNG, GIF íŒŒì¼ ì§€ì› (ìµœëŒ€ 2MB/íŒŒì¼)</p>
              </div>
              <div class="space-y-3" id="imageUploads">
                <div class="image-upload-item">
                  <input type="file" name="image_file_1" accept="image/*" onchange="handleImageUpload(event, 1)" class="hidden" id="imageFile1">
                  <input type="hidden" name="image_url_1" id="imageUrl1">
                  <div class="flex gap-2">
                    <button type="button" onclick="document.getElementById('imageFile1').click()" class="flex-1 px-4 py-2 border-2 border-dashed border-blue-300 rounded hover:border-blue-500 hover:bg-blue-50 text-sm text-blue-600">
                      <i class="fas fa-upload mr-2"></i>ì´ë¯¸ì§€ #1 ì„ íƒ
                    </button>
                    <button type="button" onclick="clearImage(1)" class="px-3 py-2 bg-red-100 text-red-600 rounded hover:bg-red-200 text-sm">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                  <div id="imagePreview1" class="mt-2 hidden">
                    <img src="" alt="Preview 1" class="w-full h-32 object-cover rounded border">
                  </div>
                </div>
                <div class="image-upload-item">
                  <input type="file" name="image_file_2" accept="image/*" onchange="handleImageUpload(event, 2)" class="hidden" id="imageFile2">
                  <input type="hidden" name="image_url_2" id="imageUrl2">
                  <div class="flex gap-2">
                    <button type="button" onclick="document.getElementById('imageFile2').click()" class="flex-1 px-4 py-2 border-2 border-dashed border-blue-300 rounded hover:border-blue-500 hover:bg-blue-50 text-sm text-blue-600">
                      <i class="fas fa-upload mr-2"></i>ì´ë¯¸ì§€ #2 ì„ íƒ
                    </button>
                    <button type="button" onclick="clearImage(2)" class="px-3 py-2 bg-red-100 text-red-600 rounded hover:bg-red-200 text-sm">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                  <div id="imagePreview2" class="mt-2 hidden">
                    <img src="" alt="Preview 2" class="w-full h-32 object-cover rounded border">
                  </div>
                </div>
                <div class="image-upload-item">
                  <input type="file" name="image_file_3" accept="image/*" onchange="handleImageUpload(event, 3)" class="hidden" id="imageFile3">
                  <input type="hidden" name="image_url_3" id="imageUrl3">
                  <div class="flex gap-2">
                    <button type="button" onclick="document.getElementById('imageFile3').click()" class="flex-1 px-4 py-2 border-2 border-dashed border-blue-300 rounded hover:border-blue-500 hover:bg-blue-50 text-sm text-blue-600">
                      <i class="fas fa-upload mr-2"></i>ì´ë¯¸ì§€ #3 ì„ íƒ
                    </button>
                    <button type="button" onclick="clearImage(3)" class="px-3 py-2 bg-red-100 text-red-600 rounded hover:bg-red-200 text-sm">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                  <div id="imagePreview3" class="mt-2 hidden">
                    <img src="" alt="Preview 3" class="w-full h-32 object-cover rounded border">
                  </div>
                </div>
                <div class="image-upload-item">
                  <input type="file" name="image_file_4" accept="image/*" onchange="handleImageUpload(event, 4)" class="hidden" id="imageFile4">
                  <input type="hidden" name="image_url_4" id="imageUrl4">
                  <div class="flex gap-2">
                    <button type="button" onclick="document.getElementById('imageFile4').click()" class="flex-1 px-4 py-2 border-2 border-dashed border-blue-300 rounded hover:border-blue-500 hover:bg-blue-50 text-sm text-blue-600">
                      <i class="fas fa-upload mr-2"></i>ì´ë¯¸ì§€ #4 ì„ íƒ
                    </button>
                    <button type="button" onclick="clearImage(4)" class="px-3 py-2 bg-red-100 text-red-600 rounded hover:bg-red-200 text-sm">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                  <div id="imagePreview4" class="mt-2 hidden">
                    <img src="" alt="Preview 4" class="w-full h-32 object-cover rounded border">
                  </div>
                </div>
                <div class="image-upload-item">
                  <input type="file" name="image_file_5" accept="image/*" onchange="handleImageUpload(event, 5)" class="hidden" id="imageFile5">
                  <input type="hidden" name="image_url_5" id="imageUrl5">
                  <div class="flex gap-2">
                    <button type="button" onclick="document.getElementById('imageFile5').click()" class="flex-1 px-4 py-2 border-2 border-dashed border-blue-300 rounded hover:border-blue-500 hover:bg-blue-50 text-sm text-blue-600">
                      <i class="fas fa-upload mr-2"></i>ì´ë¯¸ì§€ #5 ì„ íƒ
                    </button>
                    <button type="button" onclick="clearImage(5)" class="px-3 py-2 bg-red-100 text-red-600 rounded hover:bg-red-200 text-sm">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                  <div id="imagePreview5" class="mt-2 hidden">
                    <img src="" alt="Preview 5" class="w-full h-32 object-cover rounded border">
                  </div>
                </div>
              </div>
            </div>
            
            <div><label class="block text-sm font-medium mb-2">${t('text_info')} (í•œêµ­ì–´|||English|||ä¸­æ–‡)</label>
            <textarea name="text_info" rows="5" class="w-full border rounded px-4 py-2" placeholder="ì˜ˆ: í”„ë¡œì íŠ¸ ì„¤ëª…|||Project description|||é¡¹ç›®è¯´æ˜"></textarea></div>
            
            <div class="flex gap-3 justify-end pt-4 border-t">
              <button type="button" onclick="closeForm()" class="px-6 py-2 border rounded">${t('cancel')}</button>
              <button type="submit" class="px-6 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
                <i class="fas fa-save mr-2"></i>${t('save')}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  `;
}

function showForm() {
  editing = null;
  document.getElementById('formTitle').textContent = t('new_project');
  document.getElementById('form').reset();
  document.getElementById('modal').classList.remove('hidden');
}

function closeForm() {
  document.getElementById('modal').classList.add('hidden');
  editing = null;
}

async function save(e) {
  e.preventDefault();
  const formData = new FormData(e.target);
  const data = {};
  
  // Process multilingual fields
  for (const [key, value] of formData.entries()) {
    if (key === 'title' || key === 'description' || key === 'text_info') {
      const parts = value.split('|||').map(s => s.trim());
      data[key] = parts[0] || value;
      data[`${key}_ko`] = parts[0] || value;
      data[`${key}_en`] = parts[1] || parts[0] || value;
      data[`${key}_zh`] = parts[2] || parts[0] || value;
    } else {
      data[key] = value || null;
    }
  }
  
  try {
    if (editing) {
      await axios.put(`/api/projects/${editing}`, data);
      alert(t('success_updated'));
    } else {
      await axios.post('/api/projects', data);
      alert(t('success_added'));
    }
    
    closeForm();
    await renderAdminPanel();
  } catch (error) {
    console.error('ì €ì¥ ì˜¤ë¥˜:', error);
    alert(t('error_save') + error.message);
  }
}

async function edit(id) {
  editing = id;
  const project = projects.find(p => p.id == id);
  document.getElementById('formTitle').textContent = t('edit');
  const form = document.getElementById('form');
  
  // Restore multilingual fields
  Object.keys(project).forEach(k => {
    if (k === 'title' || k === 'description' || k === 'text_info') {
      const ko = project[`${k}_ko`] || project[k] || '';
      const en = project[`${k}_en`] || project[k] || '';
      const zh = project[`${k}_zh`] || project[k] || '';
      if (form.elements[k]) {
        form.elements[k].value = `${ko}|||${en}|||${zh}`;
      }
    } else if (!k.endsWith('_ko') && !k.endsWith('_en') && !k.endsWith('_zh') && !k.includes('created_at')) {
      if (form.elements[k]) form.elements[k].value = project[k] || '';
    }
  });
  
  // Restore image previews
  for (let i = 1; i <= 5; i++) {
    const imageUrl = project[`image_url_${i}`];
    if (imageUrl) {
      document.getElementById(`imageUrl${i}`).value = imageUrl;
      const preview = document.getElementById(`imagePreview${i}`);
      preview.querySelector('img').src = imageUrl;
      preview.classList.remove('hidden');
      
      const button = document.querySelector(`button[onclick*="imageFile${i}"]`);
      if (button) {
        button.innerHTML = `<i class="fas fa-check-circle mr-2"></i>ì´ë¯¸ì§€ #${i} ì—…ë¡œë“œ ì™„ë£Œ`;
        button.classList.remove('border-blue-300', 'text-blue-600');
        button.classList.add('border-green-500', 'text-green-600', 'bg-green-50');
      }
    }
  }
  
  document.getElementById('modal').classList.remove('hidden');
}

async function del(id) {
  if (!confirm(t('confirm_delete'))) return;
  
  try {
    await axios.delete(`/api/projects/${id}`);
    alert(t('success_deleted'));
    await renderAdminPanel();
  } catch (error) {
    console.error('ì‚­ì œ ì˜¤ë¥˜:', error);
    alert(t('error_delete'));
  }
}

// Image upload handling
function handleImageUpload(event, index) {
  const file = event.target.files[0];
  if (!file) return;
  
  // Check file size (2MB max)
  if (file.size > 2 * 1024 * 1024) {
    alert('íŒŒì¼ í¬ê¸°ëŠ” 2MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
    event.target.value = '';
    return;
  }
  
  // Check file type
  if (!file.type.startsWith('image/')) {
    alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
    event.target.value = '';
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    const dataUrl = e.target.result;
    
    // Store data URL in hidden input
    document.getElementById(`imageUrl${index}`).value = dataUrl;
    
    // Show preview
    const preview = document.getElementById(`imagePreview${index}`);
    preview.querySelector('img').src = dataUrl;
    preview.classList.remove('hidden');
    
    // Update button text
    const button = event.target.parentElement.querySelector('button');
    button.innerHTML = `<i class="fas fa-check-circle mr-2"></i>ì´ë¯¸ì§€ #${index} ì—…ë¡œë“œ ì™„ë£Œ`;
    button.classList.remove('border-blue-300', 'text-blue-600');
    button.classList.add('border-green-500', 'text-green-600', 'bg-green-50');
  };
  
  reader.readAsDataURL(file);
}

function clearImage(index) {
  // Clear file input
  const fileInput = document.getElementById(`imageFile${index}`);
  if (fileInput) fileInput.value = '';
  
  // Clear hidden input
  const urlInput = document.getElementById(`imageUrl${index}`);
  if (urlInput) urlInput.value = '';
  
  // Hide preview
  const preview = document.getElementById(`imagePreview${index}`);
  if (preview) {
    preview.classList.add('hidden');
    preview.querySelector('img').src = '';
  }
  
  // Reset button
  const button = fileInput.parentElement.querySelector('button[onclick*="click"]');
  if (button) {
    button.innerHTML = `<i class="fas fa-upload mr-2"></i>ì´ë¯¸ì§€ #${index} ì„ íƒ`;
    button.classList.remove('border-green-500', 'text-green-600', 'bg-green-50');
    button.classList.add('border-blue-300', 'text-blue-600');
  }
}

function loadPage() {
  const hash = window.location.hash;
  if (hash === '#/admin' || hash === '#admin') {
    document.getElementById('mainContent').style.display = 'none';
    document.getElementById('adminContent').style.display = 'block';
    renderAdminPanel();
  } else {
    document.getElementById('mainContent').style.display = 'block';
    document.getElementById('adminContent').style.display = 'none';
    loadProjects();
  }
}

window.addEventListener('hashchange', loadPage);
window.addEventListener('load', loadPage);
